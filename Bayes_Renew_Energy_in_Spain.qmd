---
title: "Final Project"
format: html
editor: visual
---

## Bayes Renewable Energy Forecasting

[Data on Kaggle](https://www.kaggle.com/datasets/nicholasjhana/energy-consumption-generation-prices-and-weather/data)

**Objective:** Plot the distribution of total energy demand. Can any of the features in the data help us predict demand? Can any of the features in the data help us predict wind or solar energy generation. Can we forecast a renewable energy sources supply and total energy demand to see the gap?

**Guidance:** Join the data, extract features from date (day of week, season, hour, etc..), filter city for Barcelona

## Loading in Libraries

```{r, warning = FALSE, message=FALSE}
# Libraries
library(janitor)
library(here)
library(tidyverse)
library(rstan)
library(bayesrules)
library(bayesplot)
library(broom.mixed)
library(ggpubr)
library(corrplot)
library(car)
library(rstanarm)
```

## Reading in Data

```{r}
energy_data <- read_csv("Data/energy_dataset.csv")
weather_features_data <- read_csv("Data/weather_features.csv")
```

## Joining the Data Frames Together

```{r}
names(weather_features_data)[names(weather_features_data) == "dt_iso"] <- "time"
str(weather_features_data)
```

```{r}
energy_weather_data <- merge(energy_data, weather_features_data, by = c("time"))
```

```{r}
# Writing a New CSV File
write.csv(energy_weather_data, "energy_weather_data")
```

## Exploratory Analysis

#### Exploring Combined Dataset

```{r}
energy_weather_data <- read_csv("energy_weather_data")
dim(energy_weather_data)
```

#### Filter for Barcelona

```{r}
barcelona_weather_data <- energy_weather_data %>% 
  filter(city_name == "Barcelona")
```

#### Looking at the `dim` of new `barcelona_weather_data`

```{r}
dim(barcelona_weather_data)
```

#### Count columns that have too much `zeros` or `NAs`

```{r}
df_na <- as.data.frame(colSums(is.na(barcelona_weather_data)))
```

#### Count `zeros`

```{r}
df_zero <- as.data.frame(colSums(barcelona_weather_data==0))
```

#### Combine zero and NA data for better viewing

```{r}
df_zero_na <- cbind(df_na, df_zero)
```

#### Remove other columns such as city_name and have only zero/NA values

```{r}
barcelona_1 <- subset(barcelona_weather_data, select = -c(city_name, temp_min, temp_max, weather_id, `generation hydro pumped storage aggregated`, `forecast wind offshore eday ahead`, rain_1h, rain_3h, snow_3h))

```

#### Removing rows with NA values

```{r}
barcelona_1 <- na.omit(barcelona_1)
```

#### Extract Date Features (Month, Year, Day)

```{r}
str(barcelona_1$time)
```

```{r}
barcelona_1$year <- format(barcelona_1$time, "%Y")
barcelona_1$month <- format(barcelona_1$time, "%m")
barcelona_1$day <- format(barcelona_1$time, "%d")
barcelona_1$day_of_the_week <- format(barcelona_1$time, "%a")
```

```{r}
# Converting columns to numerical items
barcelona_1 <- transform(barcelona_1,
                         month = as.numeric(month),
                         day = as.numeric(day))
```

##### Seasons in Spain link: <https://seasonsyear.com/Spain/Barcelona>

```{r}
barcelona_1 <- barcelona_1 %>%
  mutate(season = case_when(
    month >= 3 & month <= 5 ~ "Spring",
    month >= 6 & month <= 8 ~ "Summer",
    month >= 9 & month <= 11 ~ "Fall",
    TRUE ~ "Winter"
  ))

```

This unique function is to just explore different values in certain columns of the dataset

```{r}
sort(unique(barcelona_1$season))
```

```{r, warning = FALSE, message=FALSE}
view(barcelona_1)
```

#### Removing row with 2014 data value

##### Since their is only one value for the year `2014` we decided to remove that row

```{r}
barcelona_1 <- barcelona_1[!(row.names(barcelona_1) %in% c("1")),]
```

#### Data Visuals

Plot that looks at the amount of waste generated each year in Barcelona

```{r}
ggplot(data = barcelona_1, aes(x = year, y = `generation solar`, fill = year)) +
  geom_boxplot() 

ggplot(data = barcelona_1, aes(x = year, y = `forecast wind onshore day ahead`, fill = year)) +
  geom_boxplot() 
```

```{r}
ggplot(data = barcelona_1, aes(x = `total load actual`, y = `generation solar`)) +
  geom_hex() +
  stat_smooth(method = "lm") 
```

```{r}
ggplot(data = barcelona_1, aes(x = `price actual`, y = `generation solar`)) +
  geom_hex() +
  stat_smooth(method = "lm") 
```

Mutliple Box Plots that look at Total Load Actual by Month, Days of the Week, and Season

```{r}
ggplot(data = barcelona_1, aes(x = day_of_the_week, y = `total load actual`, fill = day_of_the_week)) +
  geom_boxplot()

ggplot(data = barcelona_1, aes(x = season, y = `total load actual`, fill = season)) +
  geom_boxplot()
```

## Features Importance

#### Correlations

```{r}
barcelona_cor <- barcelona_1 %>% 
  select(where(is.numeric)) %>% 
  select(-c(...1))

cor_total <- cor(barcelona_cor)

png(filename = "total_corrplot.png", width = 1200, height = 800)

corrplot(cor_total, method = "number")

#dev.off()
```

#### Remove more columns that do not show values in correlation matrix

```{r}
colnames(barcelona_cor)
```

```{r}
barcelona_new_cor <- barcelona_cor %>% 
  select(-c(`generation fossil coal-derived gas`,`generation fossil oil shale`,
            `generation fossil peat`,`generation geothermal`,`generation marine`,
            `generation wind offshore`))
```

```{r}
png(filename = "total_new_corrplot.png", width = 1500, height = 1200)

corrplot(cor(barcelona_new_cor), method = "number", type="lower", tl.srt = 45)

dev.off()
```

#### Use lm() and identify columns that have a statistical significance with 'total load actual' based on columns that have correlation

```{r}
colnames(barcelona_new_cor)
```

```{r}
lm_model <- lm(`total load actual` ~ `generation fossil brown coal/lignite`+
                 `generation fossil gas` + `generation fossil hard coal` +
                 `generation fossil oil` + `generation hydro water reservoir` +
                 `generation solar`, data = barcelona_1)

lm_df <- summary(lm_model)
```

```{r}
lm_df_tidy <- tidy(lm_df)
head(lm_df_tidy)

lm_df_tidy_significant <- lm_df_tidy %>% 
  filter(p.value < 0.05)

view(lm_df_tidy_significant)
```

```{r}
barcelona_new <- barcelona_1 %>% 
  select(`generation fossil gas`,`generation fossil hard coal`,
         `generation fossil oil`, `generation hydro water reservoir`, 
         `generation solar`,`total load actual`)
```

```{r}
lm_model <- lm(`total load actual` ~ ., data = barcelona_new)

summary(lm_model)
```

#### Check for multicollinearity (should be after correlation)

```{r}
vif(lm_model)
```

#### Use lm() and identify columns that have a statistical significance with 'generation wind onshore'

```{r}
summary(barcelona_1$`generation wind onshore`)
summary(barcelona_1$`generation wind offshore`)
```

```{r}
lm_wind <- lm(`generation wind onshore` ~ ., data = barcelona_1)

lm_wind_model <- summary(lm_wind)

lm_wind_tidy <- tidy(lm_wind_model)

lm_wind_tidy_significant <- lm_wind_tidy %>% 
  filter(p.value < 0.05)

#view(lm_wind_tidy_significant)
```

#### Use lm() and identify columns that have a statistical significance with 'generation solar'

```{r}
lm_solar <- lm(`generation solar` ~ ., data = barcelona_1)

lm_solar_model <- summary(lm_solar)

lm_solar_tidy <- tidy(lm_solar_model)

lm_solar_tidy_significant <- lm_solar_tidy %>% 
  filter(p.value < 0.05)

#view(lm_solar_tidy_significant)
```

```{r}
summary(lm_solar)
```

Density Plot

```{r}
ggplot(barcelona_1, aes(x = `total load actual`)) +
  geom_density(alpha = 0.6, fill = "navy")
```

## Bayesian Method

#### Bayesian Approach using stan_glm()

```{r}
barcelona_model <- stan_glm(
  `total load actual` ~ `generation fossil gas`,
  data = barcelona_1,
  family = gaussian(),
  prior = normal(0, 2),
  chains = 4,
  iter = 2000,
  seed = 123
)
```

Bayesian Regression Model

```{r}
summary(barcelona_1$`generation fossil oil shale`)
```

#### Bayesian Non-Renewable Energy (Neris Start Here)

This model will render. Need you to try and print out speific results with "new data." Use the Bayesian Linear Regression Lecture

```{r}
barcelona_non_renewable_energy_sources <- stan_glm( 
  `total load actual` ~ `generation fossil brown coal/lignite` +
  `generation fossil hard coal` + `generation fossil gas` + `generation fossil oil` + `generation nuclear`,
  data = barcelona_1,
  family = gaussian(),  # ensure this is a function call for the Gaussian family
  chains = 4, 
  iter = 5000, 
  seed = 84735
)
```

```{r}
new_data_for_prediction <- data.frame(
  temp_feel = 75, 
  temp_actual = 70,
  season = "summer",      
  year = 2011,           
  month = "Sep",             
  day_of_week = "Wed", 
  weekend = FALSE,           
  holiday = "yes",            
  humidity = 53.6667,      
  windspeed = 16,        
  weather_cat = "categ1"   
)
```

```{r}
prediction <- 
  posterior_predict(bike_model_all, newdata = new_data_for_prediction)
```

```{r}
mcmc_dens(prediction) + 
  xlab("new prediction of rides")
```

## Answering the Following Questions

## 
